apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: build-data-release-eventsource
  namespace: data-release
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  template:
    serviceAccountName: data-release-service-account # assign a service account with `get`, `list` and `watch` permissions on the resource being watched.
  resource:
    data-release-success:
      namespace: argo-workflows # namespace to listen events within
      group: argoproj.io
      version: v1alpha1
      resource: workflows
      eventTypes:
        - ADD # ADD, DELETE, UPDATE
      filter:
        afterStart: true
        labels:
          - key: trigger_release
            operation: ==
            value: "True"
          - key: workflows.argoproj.io/phase
            operation: ==
            value: "Succeeded"
        fields:
          - key: status.phase
            operation: ==
            value: "Succeeded"
      # Extract only necessary fields to avoid NATS max payload exceeded errors
      payloadFilter:
        - key: metadata.name
        - key: metadata.namespace
        - key: metadata.labels
        - key: status.phase
        - key: status.finishedAt
        - key: status.startedAt
