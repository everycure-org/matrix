apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: build-data-release-sensor-post-release
  namespace: data-release
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  template:
    serviceAccountName: data-release-service-account
  dependencies:
    - name: dependency_release_version
      eventSourceName: build-data-release-eventsource
      eventName: data-release-success
  triggers:
    - template:
        name: argo-workflow
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                namespace: data-release
                generateName: distribute-data-release-
                labels:
                  app: distribute-data-release
              spec:
                serviceAccountName: data-release-service-account
                entrypoint: trigger-curl
                arguments:
                  parameters:
                    - name: release_version
                      value: hello
                    - name: git_sha
                      value: hello
                templates:
                - name: trigger-curl
                  inputs:
                    parameters:
                      - name: git_sha
                      - name: release_version
                  container:
                    image: curlimages/curl:latest # Use a lightweight curl image
                    command: ["sh", "-c"]
                    args:
                      - >
                        curl -H "Accept: application/vnd.github.everest-preview+json" \
                             -H "Authorization: token $GITHUB_TOKEN" \
                             --request POST \
                             --data '{\
                               "event_type": "distribute-release",\
                               "client_payload": { \
                                 "release_version": "{{`{{inputs.parameters.release_version}}`}}", \
                                 "git_fingerprint": "{{`{{inputs.parameters.git_sha}}`}}" \
                               } \
                             }' \
                             https://api.github.com/repos/everycure-org/matrix/dispatches
                    env:
                      - name: GITHUB_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: gh-password
                            key: GH_CREDS

          parameters:
            - src:
                dependencyName: dependency_release_version
                dataKey: body.metadata.labels.release_version
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: dependency_release_version
                dataKey: body.metadata.labels.git_sha
              dest: spec.arguments.parameters.1.value