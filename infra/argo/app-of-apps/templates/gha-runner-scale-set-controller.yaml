apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gha-runner-scale-set-controller
  namespace: argocd
spec:
  destination:
    namespace: actions-runner-system
    server: {{ .Values.spec.destination.server }}
  project: default
  source:
    chart: gha-runner-scale-set-controller
    repoURL: oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
    targetRevision: 0.9.3
    helm:
      values: |
        # Override specific values here
        
        # Controller Configuration
        replicaCount: 1
        
        # Resource requests for the controller
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
        
        # Schedule on management nodes
        nodeSelector:
          workload-type: management
        
        # Tolerate management node taints
        tolerations:
          - key: workload-type
            operator: Equal
            value: management
            effect: NoSchedule
        
        # Security context
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 1001
          runAsGroup: 1001
          fsGroup: 1001
        
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          runAsGroup: 1001
          fsGroup: 1001
        
        # Add billing labels for cost tracking
        podLabels:
          cost-center: infrastructure-management
          workload-category: platform-services
          service-tier: management
          billing-category: infrastructure
          component: gha-runner-scale-set-controller
        
        # Pod annotations for monitoring
        podAnnotations:
          cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
        
        # Controller flags and configuration
        flags:
          logLevel: "info"
          logFormat: "text"
          runnerMaxConcurrentReconciles: 5
          updateStrategy: "immediate"
          excludeLabelPropagationPrefixes:
            - "argocd.argoproj.io/instance"
        
        # Enable metrics
        metrics:
          controllerManagerAddr: ":8080"
          listenerAddr: ":8080"
          listenerEndpoint: "/metrics"
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      allowEmpty: true
