# Define the image name
IMAGE_NAME = kg-dashboard
REPO_NAME = matrix-images
PROJECT_ID = $(shell gcloud config get-value project)
EVIDENCE_BASE_PATH = gs://data.dev.everycure.org/runs

# # controls the release version of the KG used in the dashboard
# RELEASE_VERSION ?= v0.4.0
# export EVIDENCE_VAR__release_version := $(RELEASE_VERSION)
# export EVIDENCE_VAR__bq_release_version := $(subst .,_,$(RELEASE_VERSION))
# export VITE_release_version := $(RELEASE_VERSION)
# export VITE_build_time := $(shell date -u '+%B %d, %Y at %H:%M:%S UTC')

RUN ?= 045-modelling-run-75339eb5
export EVIDENCE_VAR__run_id := $(RUN)

.ONESHELL:

.PHONY: clean install bump_basepath run-dev

bump_basepath:
	node ./scripts/update-basepath.cjs $(RELEASE_VERSION)

build: bump_basepath 
	@echo "Building with EVIDENCE_VAR__release_version=$(EVIDENCE_VAR__release_version)"
	npm run build:strict

deploy: 
	# both rsyncs are set up to delete extra files. We use gcloud storage over gsutil because gsutil does not use github action authentication
	gcloud storage rsync --recursive --delete-unmatched-destination-objects build/ $(EVIDENCE_BASE_PATH)/$(RELEASE_VERSION)/evidence
	gcloud storage rsync --recursive --delete-unmatched-destination-objects $(EVIDENCE_BASE_PATH)/$(RELEASE_VERSION)/evidence $(EVIDENCE_BASE_PATH)/latest/evidence



install:
	npm install

run-sources:
	npm run sources

run-dev:
	npm run dev

clean:
	rm -rf build
	rm -rf node_modules
	rm -rf .evidence
