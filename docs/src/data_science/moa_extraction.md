---
title: "MOA extraction pipeline"
---

# MOA extraction pipeline

Mechanism of action (MOA) prediction models aim to predict the biological pathways by which a given drug acts on a given disease. 
The MOA extraction module is an example of a path-based approach to MOA prediction. It extracts paths in the the knowledge graph that are likely to be relevant to the MOA of a given drug-disease pair.
The MOA extraction module is loosely inspired by the [KGML-xDTD](https://github.com/kgml-xdt/kgml-xdt) MOA module which extracts paths in the KG using an adversarial actor-critic reinforcement learning algorithm. 
In contrast, we use a simpler approach of extracting paths using a supervised binary classifier. 

## Methodology

The main component of the MOA extraction system is a binary classifier that predicts whether a given path in the knowledge graph is likely to represent a mechanism of action for a given drug-disease pair. This is illustrated in the following diagram:

![Path classifier](../assets/img/MOA_extraction/path_classifier.svg)

An example of such a binary classifier is a transformer model (encoder only) with a linear output layer. In this case, the input path needs to be embedded as a sequence of vectors. More details on the embedding process are provided in the [configuration details section](#configuration-details).

A different binary classifier is trained for each length of path. Currently our system supports 2 or 3 hop paths, so two binary classifiers are trained.

Now, fix the number of hops to be $n$. To use the binary classier to predict $n$-hop MOAs for a given drug-disease pair, we perform the following process:
1. Extract all $n$-hop paths between the drug and disease in the knowledge graph. This is achieved using a neo4j query.
2. Assign a score to each path using the binary classifier and rank accordingly.
3. Return the top-k paths as the predicted MOAs for the given drug-disease pair.

Furthermore, our system supports explicit filters to be applied to the paths extracted in step 1, for instance, remove any path containing a drug-disease edge (more on this in the [path extraction rules section](#path-extraction-rules)). The prediction process is illustrated by the following diagram:

![Inference process](../assets/img/MOA_extraction/path_inference.svg)

The training dataset set for the binary classifier consists of positive (MOA) and negative (non-MOA) paths. 

1. The positive examples are extracted using the [DrugMechDB](https://sulab.github.io/DrugMechDB/) database. The process of mapping the DrugMechDB paths to the knowledge graph is non-trivial and more details are provided in the [path mapping section](#path-mapping).
2. The negative examples are generated by randomly sampled paths. More details are given in the [negative sampling section](#negative-sampling).

The training process is illustrated by the following diagram:

![Training process](../assets/img/MOA_extraction/path_training.svg)

## Implementation

The following diagram illustrates the overall MOA extraction pipeline:

![MOA pipeline overview](../assets/img/MOA_extraction/MOA_pipeline_overview.svg)

Currently, there are two separate pipelines which must be run in sequence:

1. **DrugMechDB to KG mapping pipeline** This is run once locally. Uses a Node synonymizer to map all entities appearing DrugMechDB to the KG.
2. **Main MOA extraction pipeline** Performs all other functionality. 


The main MOA extraction pipeline itself has four separate components. 

1. **Preprocessing**:
    - Map paths in the DrugMechDB to the knowledge graph using the mapped DrugMechDB entities. Report the success rate.
    - Performs test/train split. 
    - Any other preprocessing task such as preparing one-hot encoders for the node categories and edge predicates. 
2. **Training**:
    - Sample negative paths. 
    - Hyperparameter search and training of the binary classifier using:
        - training portion of the positive indication paths dataset
        - full positive indication paths dataset (both test and train)
3. **Evaluation**:
    - Make MOA predictions for pairs appearing in the test set of the positive indication paths dataset.
    - Evaluate the predictions using Hit@k and Mean Reciprocal Rank (MRR) metrics.
4. **Prediction**:
    - Generates MOA predictions for a given set of drug-disease pairs.

## Configuration details

### Path mapping

### Path embedding

### Negative sampling

### Path extraction rules
