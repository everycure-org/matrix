# this workflow routes to the correct infra folder and executes the infra-deploy workflow in that folder
name: Infrastructure Deploy Router
on:
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:
      - infra
      - infra-prod-debug # temporary branch to use for prod deploymentsm TODO: to be changed
    paths:
      - infra/**
      - .github/workflows/infra-*.yml
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  push:
    branches:
      - infra
      - infra-prod-debug # temporary branch to use for prod deployments TODO: to be changed
      - chunyuma-patch-1
    paths:
      - infra/**
      - .github/workflows/infra-*.yml
  # Allow manual triggering
  workflow_dispatch:

jobs:
  call_infra_deploy_dev:
    # This job is triggered by a pull request to the infra branch or a push to the infra branch.
    if: (github.event_name == 'pull_request' && github.base_ref == 'infra') || github.ref == 'refs/heads/infra'
    uses: ./.github/workflows/infra-deploy.yml
    name: ${{ matrix.deployment_path }}
    secrets: inherit
    permissions:
      pull-requests: read
      contents: 'read'
      id-token: 'write'
    strategy:
      matrix:
        # This is the list of all terraform projects that we have. The router leverages github "Matrix" strategy to trigger a run for each folder.
        # In the infra-deploy the first step then checks if any file actually changed. If not, the folder is skipped.
        deployment_path: [  # hub/dev and wg2 are deployment paths for the infra branch, which is currently the dev env. TODO: when infra folder moved to repo matrix-infra, add a check for the branch that triggers this workflow so that this target may be adjusted.
          'hub/dev',
          'wg2'
        ]
      fail-fast: false #enables deployment of both of these environments, not aborting one if the other fails
    with:
      deployment_path: ${{ matrix.deployment_path }}
      environment: 'dev'

  call_infra_deploy_prod:
    # This job is triggered by a pull request to the infra-prod-debug branch or a push to the infra-prod-debug branch.
    if: (github.event_name == 'pull_request' && github.base_ref == 'infra-prod-debug') || github.ref == 'refs/heads/infra-prod-debug'
    uses: ./.github/workflows/infra-deploy.yml
    name: ${{ matrix.deployment_path }}
    secrets: inherit
    permissions:
      pull-requests: read
      contents: 'read'
      id-token: 'write'
    strategy:
      matrix:
        # This is the list of all terraform projects that we have. The router leverages github "Matrix" strategy to trigger a run for each folder.
        # In the infra-deploy the first step then checks if any file actually changed. If not, the folder is skipped.
        deployment_path: [ # hub/dev and wg2 are deployment paths for the infra branch, which is currently the dev env. TODO: when infra folder moved to repo matrix-infra, add a check for the branch that triggers this workflow so that this target may be adjusted.
          'hub/prod'
        ]
      fail-fast: false #enables deployment of both of these environments, not aborting one if the other fails
    with:
      deployment_path: ${{ matrix.deployment_path }}
      environment: 'prod'
