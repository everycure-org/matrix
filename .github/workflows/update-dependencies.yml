name: Update Dependencies

on:
  schedule:
    # Run every Monday at 5 AM UTC
    - cron: '0 5 * * 1'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name for the PR (optional)'
        required: false
        default: 'deps/update-$(date +%Y-%m-%d)'

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Update Dependencies and Create PR
    permissions:
      contents: 'write'
      pull-requests: 'write'
      actions: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git config --global push.autosetupremote true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Navigate to Matrix Pipeline
        working-directory: pipelines/matrix
        run: |
          echo "Working in $(pwd)"

      - name: Run make lock
        working-directory: pipelines/matrix
        run: |
          make lock

      - name: Check for changes
        id: check_changes
        working-directory: pipelines/matrix
        run: |
          if git diff --exit-code requirements.txt; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in requirements.txt"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in requirements.txt"
          fi

      - name: Create branch and commit changes
        if: steps.check_changes.outputs.changes == 'true'
        working-directory: pipelines/matrix
        run: |
          # Generate branch name
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.branch_name }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="deps/update-$(date +%Y-%m-%d)"
          fi
          
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          
          # Create and switch to new branch
          git checkout -b "$BRANCH_NAME"
          
          # Add and commit changes
          git add requirements.txt
          git commit -m "chore: update dependencies via make lock
          
          This commit updates the locked dependencies by running 'make lock'
          which compiles requirements.in to requirements.txt using uv."
          
          # Push the branch
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Create PR
          gh pr create \
            --title "chore: update dependencies $(date +%Y-%m-%d)" \
            --base main \
            --body "## Dependency Update


          This PR updates the locked dependencies by running \`make lock\` which compiles \`requirements.in\` to \`requirements.txt\` using uv.

          ### What Changed
          - Updated locked dependency versions in \`pipelines/matrix/requirements.txt\`
          - Generated by running \`make lock\` which uses \`uv pip compile\`

          ### Review Instructions
          - Review the changes in \`pipelines/matrix/requirements.txt\`
          - Ensure no breaking changes were introduced

          ### Auto-generated
          This PR was automatically created by the GitHub Action workflow." \
            --label "dependencies" \
            --label "automated"

      - name: Comment on PR if no changes
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "No dependency changes detected. Skipping PR creation." 