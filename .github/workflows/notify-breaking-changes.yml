# This workflow is triggered by a pull_request merge event. We want to notify people if a PR is labeled as `breaking change` so that they don't wonder why suddenly main is broken

name: Notify Breaking Changes

on:
#  pull_request:
#    types: [closed]
   pull_request:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Log github.event
        run: |
          echo ${{ toJSON(github.event) }}

      - name: Post to a Slack channel
        if: contains(github.event.pull_request.labels, 'breaking change') && github.event.pull_request.merged == 'true'
        id: slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          # Slack channel id, channel name, or user id to post message.
          # See also: https://api.slack.com/methods/chat.postMessage#channels
          # You can pass in multiple channels to post to by providing a comma-delimited list of channel IDs.
          # TODO: Change
          channel-id: 'C07HU35MKAQ' #github-notifications
          # For posting a simple plain text message
          slack-message: |
            GitHub Build Failed on Main branch! üö®

            üë©‚Äçüíª Code URL: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}
            üöÄ Action run link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN_MATRIX_WORKSPACE }}
