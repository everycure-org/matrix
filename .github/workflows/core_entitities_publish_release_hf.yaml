name: Core Entities HuggingFace Release
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v0.2.0) â€” must already be published to GCS'
        required: true
        type: string
      pipeline:
        description: 'Pipeline name'
        required: true
        type: choice
        options:
          - drug_list
          - disease_list

jobs:
  publish_hf:
    name: Publish to HuggingFace Hub
    environment: dev
    runs-on: gha-runner-scale-set
    defaults:
      run:
        working-directory: ./pipelines/core_entities
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Configure Git to use PAT
      run: git config --global url."https://everycure:${{ secrets.GH_TOKEN }}@github.com/".insteadOf "https://github.com/"

    - name: Authenticate with Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        project_id: ${{ vars.PROJECT_ID }}
        workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER_RW }}
        service_account: ${{ vars.SERVICE_ACCOUNT_RW }}

    - name: Install gcloud storage
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: latest

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v2

    - name: Install dependencies
      run: make install

    - name: Publish to HuggingFace Hub
      env:
        PIPELINE_NAME: ${{ inputs.pipeline }}
        RELEASE_VERSION: ${{ inputs.release_version }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        uv run kedro run -e cloud --pipeline="publish_${PIPELINE_NAME}_hf"
