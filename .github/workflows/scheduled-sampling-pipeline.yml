name: Scheduled Sampling Pipeline

on:
  schedule:
    - cron: '0 9 * * 1' # every monday at 9 am UTC
  push:
    branches:
      - feat/run_sampling_pipeline_on_schedule

env:
  project_id: 'mtrx-hub-dev-3of'
  workload_identity_provider: 'projects/938607797672/locations/global/workloadIdentityPools/matrix-pool-rw/providers/matrix-gh-provider-rw'
  service_account: 'sa-github-actions-rw@mtrx-hub-dev-3of.iam.gserviceaccount.com'
  region: 'us-central1'
  cluster: 'compute-cluster'

jobs:

  submit_sampling_pipeline:
    runs-on: 
      labels: ubuntu-24.04
    name: Submit the Kedro Pipeline Periodically
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'
 
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-tags: true
          fetch-depth: 0  # full depth needed so we can pass the AI all logs since the last release.
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up kedro project dependencies
        working-directory: pipelines/matrix
        run: |
          pip install -r requirements.txt

      - name: Authenticate with Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{env.project_id}}
          # workload_identity_provider: ${{env.workload_identity_provider}}
          service_account: ${{env.service_account}}
          token_format: access_token

      - name: Download release info file
        working-directory: docs/src/releases/changelog_files
        env:
          RELEASE_DIR_GCS: 'gs://mtrx-us-central1-hub-dev-storage/kedro/data/releases'
          FILENAME: v0.2.7_info.json
        run: |
          set -eux
          BLOB_PATH="${RELEASE_DIR_GCS}/v0.2.7/${FILENAME}"
          gcloud storage cp "$BLOB_PATH" "$FILENAME"
      - name: Run the kedro sampling pipeline
        working-directory: pipelines/matrix
        run: |
          echo "Run the kedro sampling pipeline"
          kedro run \
            -e sample \
            -p test_sample

#      - name: Post to a Slack channel
#        # Only post to Slack if the deployment failed and we're on the infra branch
#        if: failure()
#        id: slack
#        uses: slackapi/slack-github-action@v1.26.0
#        with:
#          # Slack channel id, channel name, or user id to post message.
#          # See also: https://api.slack.com/methods/chat.postMessage#channels
#          # You can pass in multiple channels to post to by providing a comma-delimited list of channel IDs.
#          channel-id: 'C07HU35MKAQ' #github-notifications
#          # For posting a simple plain text message
#          slack-message: |
#            ðŸ§ª Weekly Sampling Pipeline Failed! ðŸš¨
#            ðŸ”— Action run link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
#        env:
#          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}