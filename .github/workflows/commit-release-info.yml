name: Commit Release Info - expand

on:
  push:
    branches:
      - 'feat/expand-trigger-release-from-gh-action'
  repository_dispatch:
    types: distribute-release

env:
  project_id: 'mtrx-hub-dev-3of'
  workload_identity_provider: 'projects/938607797672/locations/global/workloadIdentityPools/matrix-pool-rw/providers/matrix-gh-provider-rw'
  service_account: 'sa-github-actions-rw@mtrx-hub-dev-3of.iam.gserviceaccount.com'

jobs:
  create_release_notes_draft:
    runs-on: ubuntu-latest
    name: Create Draft of the Release Notes
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'

    steps:
      - name: 'Checkout'
        uses: actions/checkout@main
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Authenticate with Google Cloud v
        uses: 'google-github-actions/auth@v2'
        # if: github.ref == 'refs/heads/main'
        with:
          project_id: ${{env.project_id}}
          workload_identity_provider: ${{env.workload_identity_provider}}
          service_account: ${{env.service_account}}

      - name: store variables
        run: |
          echo "release=v123" >> "$GITHUB_ENV"

      - name: Download info file
        working-directory: docs/src/releases
        env:
          RELEASE_DIR: 'gs://mtrx-us-central1-hub-dev-storage/kedro/data/releases'
          FILENAME: ${{env.release}}_info.json
        run: |
          echo "workspace is: $GITHUB_WORKSPACE"
          mkdir -p info && cd info
          
          echo $FILENAME
          
          BLOB_PATH="${RELEASE_DIR}/${{env.release}}/${FILENAME}"
          echo $BLOB_PATH

          gcloud storage cp $BLOB_PATH $FILENAME
          cat $FILENAME

      - name: Commit info file
        working-directory: docs/src/releases/info
        env:
          RELEASE: 'v0.2.5-alpha9'
        run: |
          FILENAME="${RELEASE}_info.json"
          
          git config --global user.email "releasebot@everycure.org"
          git config --global user.name "All of us at Every Cure"
          
          git add "${FILENAME}" && \
          git commit -m "added release info json" && \
          git push --follow-tags
