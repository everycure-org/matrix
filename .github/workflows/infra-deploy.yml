name: Infrastructure Plan

on:
  workflow_dispatch: {}
  push:
    branches:
      # TODO remove
      - "feat/matrix_infra"
    paths: 
      - infra/**
      - .github/workflows/infra-deploy.yml



jobs:
  tf_plan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra
    permissions:
      contents: 'read'
      # Add "id-token" with the intended permissions.
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v4'

    # TODO remove this when its' working
    # - name: Checkout actions-oidc-debugger
    #   uses: actions/checkout@v3
    #   with:
    #     repository: github/actions-oidc-debugger
    #     ref: main
    #     token: ${{ github.token }}
    #     path: ./.github/actions/actions-oidc-debugger
    # - name: Debug OIDC Claims
    #   uses: ./.github/actions/actions-oidc-debugger
    #   with:
    #     audience: '${{ github.server_url }}/${{ github.repository_owner }}'

    # see info here: https://github.com/google-github-actions/auth/blob/main/docs/EXAMPLES.md
    - uses: 'google-github-actions/auth@v2'
      with:
        project_id: 'mtrx-hub-dev-3of'
        # workload_identity_provider: 'projects/mtrx-hub-dev-3of/locations/global/workloadIdentityPools/matrix-pool/providers/matrix-gh-provider'
        workload_identity_provider: 'projects/938607797672/locations/global/workloadIdentityPools/matrix-pool/providers/matrix-gh-provider'
        service_account: 'sa-github-actions-ro@mtrx-hub-dev-3of.iam.gserviceaccount.com'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'
    
    - name: test some stuff
      run: |
        gcloud info
        gcloud compute instances list
        gsutil cp gs://mtrx-us-central1-hub-dev-storage/tf_bootstrap.json ./
        cat tf_bootstrap.json

