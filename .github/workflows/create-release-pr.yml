name: Create Pull Request to Verify AI Summary of Release Notes

on:
  push:
    branches:
      - 'feat/trigger-release-from-gh-action'  # TODO: replace by manual trigger and repository_dispatch
  workflow_dispatch:
    inputs:
      release:
        required: true
        description: Name of the release, like "v1.2.3"
        type: string

env:
  project_id: 'mtrx-hub-dev-3of'
  workload_identity_provider: 'projects/938607797672/locations/global/workloadIdentityPools/matrix-pool-rw/providers/matrix-gh-provider-rw'
  service_account: 'sa-github-actions-rw@mtrx-hub-dev-3of.iam.gserviceaccount.com'

jobs:
  create_release_notes_draft:
    runs-on: ubuntu-latest
    name: Create Draft of the Release Notes
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout'
        uses: actions/checkout@main
        with: 
          fetch-tags: true
          fetch-depth: 0

      - name: Setup Matrix CLI
        run: |
          git tag --list --sort=-v:refname
          git log v0.2.2..origin/main --oneline
          pwd
          pip install uv
          pushd apps/matrix-cli
          uv sync

      - uses: 'google-github-actions/auth@v2'
        #if: github.ref == 'refs/heads/main'
        with:
          project_id: ${{env.project_id}}
          workload_identity_provider: ${{env.workload_identity_provider}}
          service_account: ${{env.service_account}}

      - name: Create Release Notes
        working-directory: apps/matrix-cli  #docs/src/releases/posts
        run: |
          if [[ "${{ github.event_name == 'workflow_dispatch' }}" == "true" ]]; then
            release="${{ inputs.release }}"
          else
            release="v0.2.6-alpha"
          fi
          echo "$release"
          echo "${GITHUB_ENV}"
          echo "release=${release}" >> "${GITHUB_ENV}"
          mkdir -p "${release}"
          uv run matrix releases release-notes --headless --output-file "${release}/notes.md"
          uv run matrix releases article --headless --output-file "${release}/post.md" --no-disable-rendering
          mv "${release}" "${GITHUB_WORKSPACE}/docs/src/releases/posts"
          ls "${GITHUB_WORKSPACE}/docs/src/releases/posts"
          ls !$
#          git add ${release} && git commit -m "added release notes & article draft" && git push

#      - name: Create Pull Request
#        run: gh pr create \
#          --title "Release/${env.release}" \
#          --base main \
#          --body "Adds the release article and associated notes" \
#          --draft \
#          --dry-run \
#          --label Release


