timeout: "3600s"

options:
  machineType: "E2_HIGHCPU_8"

serviceAccount: "projects/mtrx-hub-dev-3of/serviceAccounts/custom-cloud-build-sa@mtrx-hub-dev-3of.iam.gserviceaccount.com"
logsBucket: "gs://mtrx-hub-dev-3of_cloudbuild"

substitutions:
  _IMAGE: ""
  _TAG: "dev"
  _GIT_SHA: ""
  _TARGET_PLATFORM: "linux/amd64"

steps:
  - name: 'gcr.io/cloud-builders/docker'
    env:
      - DOCKER_BUILDKIT=1
    args:
      - build
      - --build-arg
      - GIT_SHA=$_GIT_SHA
      - --platform
      - $_TARGET_PLATFORM
      - --cache-from 
      - $_IMAGE:$_TAG
      - -t
      - $_IMAGE
      - -t
      - $_IMAGE:$_TAG
      - -f
      - pipelines/matrix/Dockerfile
      - .

images:
  - '$_IMAGE'
  - '$_IMAGE:$_TAG'
