apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  namespace: argo-workflows
  name: integration-2
spec:
  entrypoint: dag
  templates:
  - name: kedro
    metadata:
      labels:
        app: kedro-argo
    inputs:
      parameters:
      - name: kedro_node
    container:
      imagePullPolicy: Always
      image: us-central1-docker.pkg.dev/mtrx-hub-dev-3of/matrix-images/matrix:latest
      env:
        - name: NEO4J_HOST
          value: bolt://neo4j.neo4j.svc.cluster.local:7687
        - name: NEO4J_USER
          valueFrom:
            secretKeyRef:
              name: matrix-secrets
              key: NEO4J_USER
        - name: NEO4J_PASSWORD
          valueFrom:
            secretKeyRef:
              name: matrix-secrets
              key: NEO4J_PASSWORD
        - name: OPENAI_ENDPOINT
          value: http://mock-genai:1080/v1
        - name: OPENAI_API_KEY
          value: dummy
        - name: GCP_PROJECT_ID
          valueFrom:
            configMapKeyRef:
              name: matrix-config
              key: GCP_PROJECT
        - name: GCP_BUCKET
          valueFrom:
            configMapKeyRef:
              name: matrix-config
              key: GCP_BUCKET
        - name: VERTEX_AI_ACCESS_TOKEN
          value: dummy
      # env:
      #   - name: AWS_ACCESS_KEY_ID
      #     valueFrom:
      #       secretKeyRef:
      #               #         name: aws-secrets
      #         key: access_key_id
      #   - name: AWS_SECRET_ACCESS_KEY
      #     valueFrom:
      #       secretKeyRef:
      #         name: aws-secrets
      #         key: secret_access_key
      command: [kedro]
      args: ["run", "-p", "integration", "-e", "prod", "-n", "{{inputs.parameters.kedro_node}}" ]
  - name: dag
    dag:
      tasks:
      - name: write-rtx-kg2-nodes
        template: kedro
        arguments:
          parameters:
          - name: kedro_node
            value: write_rtx_kg2_nodes
      - name: write-rtx-kg2-edges
        template: kedro
        arguments:
          parameters:
          - name: kedro_node
            value: write_rtx_kg2_edges
      - name: create-neo4j-nodes
        template: kedro
        dependencies:
          - write-rtx-kg2-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_nodes
      - name: create-neo4j-edges
        template: kedro
        dependencies:
          - write-rtx-kg2-edges
          - create-neo4j-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_edges
      - name: create-int-known-pairs
        template: kedro
        arguments:
          parameters:
          - name: kedro_node
            value: create_int_known_pairs
      - name: create-neo4j-known-pairs
        template: kedro
        dependencies:
          - create-int-known-pairs
          - create-neo4j-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_known_pairs
