apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  namespace: argo-workflows
  name: dev
spec:
  entrypoint: dag
  templates:
  - name: kedro
    metadata:
      labels:
        app: kedro-argo
    inputs:
      parameters:
      - name: kedro_node
    container:
      imagePullPolicy: Always
      image: us-central1-docker.pkg.dev/mtrx-hub-dev-3of/matrix-images/matrix:latest
      env:
        - name: NEO4J_HOST
          value: bolt://neo4j.neo4j.svc.cluster.local:7687
        - name: NEO4J_USER
          valueFrom:
            secretKeyRef:
              name: matrix-secrets
              key: NEO4J_USER
        - name: NEO4J_PASSWORD
          valueFrom:
            secretKeyRef:
              name: matrix-secrets
              key: NEO4J_PASSWORD
        - name: OPENAI_ENDPOINT
          value: https://api.openai.com/v1
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: matrix-secrets
              key: OPENAI_API_KEY
        - name: GCP_PROJECT_ID
          valueFrom:
            configMapKeyRef:
              name: matrix-config
              key: GCP_PROJECT_ID
        - name: GCP_BUCKET
          valueFrom:
            configMapKeyRef:
              name: matrix-config
              key: GCP_BUCKET
        # - name: VERTEX_AI_ACCESS_TOKEN
        #   value: dummy
      command: [kedro]
      args: ["run", "-p", "test", "-e", "prod", "-n", "{{inputs.parameters.kedro_node}}" ]
  - name: dag
    dag:
      tasks:
      - name: transform-xgc-0-data
        template: kedro
        dependencies:
          - enrich-xgc-0-splits
          - fit-xgc-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgc_0_data
      - name: enrich-xgb-0-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_xgb_0_splits
      - name: create-neo4j-nodes
        template: kedro
        dependencies:
          - write-rtx-kg2-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_nodes
      - name: write-rtx-kg2-nodes
        template: kedro
        dependencies:
          - fabricate-datasets
        arguments:
          parameters:
          - name: kedro_node
            value: write_rtx_kg2_nodes
      - name: get-kgml-xdtd-model-predictions
        template: kedro
        dependencies:
          - transform-kgml-xdtd-data
          - create-kgml-xdtd-model
        arguments:
          parameters:
          - name: kedro_node
            value: get_kgml_xdtd_model_predictions
      - name: tune-model-xg-balanced-0-parameters
        template: kedro
        dependencies:
          - transform-xg-balanced-0-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_xg_balanced_0_parameters
      - name: check-xgc-model-performance
        template: kedro
        dependencies:
          - get-xgc-model-predictions
        arguments:
          parameters:
          - name: kedro_node
            value: check_xgc_model_performance
      - name: create-splits
        template: kedro
        dependencies:
          - create-feat-nodes
          - create-neo4j-known-pairs
        arguments:
          parameters:
          - name: kedro_node
            value: create_splits
      - name: train-xgc-2-model
        template: kedro
        dependencies:
          - tune-model-xgc-2-parameters
          - transform-xgc-2-data
        arguments:
          parameters:
          - name: kedro_node
            value: train_xgc_2_model
      - name: train-xg-balanced-0-model
        template: kedro
        dependencies:
          - transform-xg-balanced-0-data
          - tune-model-xg-balanced-0-parameters
        arguments:
          parameters:
          - name: kedro_node
            value: train_xg_balanced_0_model
      - name: create-feat-nodes
        template: kedro
        dependencies:
          - create-neo4j-known-pairs
          - add-topological-embeddings
        arguments:
          parameters:
          - name: kedro_node
            value: create_feat_nodes
      - name: create-kgml-xdtd-model
        template: kedro
        dependencies:
          - train-kgml-xdtd-0-model
        arguments:
          parameters:
          - name: kedro_node
            value: create_kgml_xdtd_model
      - name: create-tp-pairs
        template: kedro
        dependencies:
          - fabricate-datasets
        arguments:
          parameters:
          - name: kedro_node
            value: create_tp_pairs
      - name: apply-pca
        template: kedro
        dependencies:
          - add-node-embeddings
        arguments:
          parameters:
          - name: kedro_node
            value: apply_pca
      - name: add-topological-embeddings
        template: kedro
        dependencies:
          - apply-pca
          - create-neo4j-edges
        arguments:
          parameters:
          - name: kedro_node
            value: add_topological_embeddings
      - name: tune-model-xgb-0-parameters
        template: kedro
        dependencies:
          - transform-xgb-0-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_xgb_0_parameters
      - name: check-xgb-model-performance
        template: kedro
        dependencies:
          - get-xgb-model-predictions
        arguments:
          parameters:
          - name: kedro_node
            value: check_xgb_model_performance
      - name: add-node-embeddings
        template: kedro
        dependencies:
          - create-neo4j-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: add_node_embeddings
      - name: enrich-kgml-xdtd-0-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_kgml_xdtd_0_splits
      - name: get-xg-balanced-model-predictions
        template: kedro
        dependencies:
          - transform-xg-balanced-data
          - create-xg-balanced-model
        arguments:
          parameters:
          - name: kedro_node
            value: get_xg_balanced_model_predictions
      - name: fit-xg-balanced-transformers
        template: kedro
        dependencies:
          - create-splits
        arguments:
          parameters:
          - name: kedro_node
            value: fit_xg_balanced_transformers
      - name: train-xgc-0-model
        template: kedro
        dependencies:
          - transform-xgc-0-data
          - tune-model-xgc-0-parameters
        arguments:
          parameters:
          - name: kedro_node
            value: train_xgc_0_model
      - name: enrich-xg-balanced-0-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_xg_balanced_0_splits
      - name: check-xg-balanced-model-performance
        template: kedro
        dependencies:
          - get-xg-balanced-model-predictions
        arguments:
          parameters:
          - name: kedro_node
            value: check_xg_balanced_model_performance
      - name: tune-model-kgml-xdtd-0-parameters
        template: kedro
        dependencies:
          - transform-kgml-xdtd-0-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_kgml_xdtd_0_parameters
      - name: transform-xgb-0-data
        template: kedro
        dependencies:
          - fit-xgb-transformers
          - enrich-xgb-0-splits
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgb_0_data
      - name: create-xgb-model
        template: kedro
        dependencies:
          - train-xgb-0-model
        arguments:
          parameters:
          - name: kedro_node
            value: create_xgb_model
      - name: create-xg-balanced-model
        template: kedro
        dependencies:
          - train-xg-balanced-0-model
        arguments:
          parameters:
          - name: kedro_node
            value: create_xg_balanced_model
      - name: tune-model-xgc-1-parameters
        template: kedro
        dependencies:
          - transform-xgc-1-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_xgc_1_parameters
      - name: transform-xg-balanced-0-data
        template: kedro
        dependencies:
          - fit-xg-balanced-transformers
          - enrich-xg-balanced-0-splits
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xg_balanced_0_data
      - name: fit-xgb-transformers
        template: kedro
        dependencies:
          - create-splits
        arguments:
          parameters:
          - name: kedro_node
            value: fit_xgb_transformers
      - name: get-xgc-model-predictions
        template: kedro
        dependencies:
          - create-xgc-model
          - transform-xgc-data
        arguments:
          parameters:
          - name: kedro_node
            value: get_xgc_model_predictions
      - name: train-xgb-0-model
        template: kedro
        dependencies:
          - transform-xgb-0-data
          - tune-model-xgb-0-parameters
        arguments:
          parameters:
          - name: kedro_node
            value: train_xgb_0_model
      - name: transform-xgc-1-data
        template: kedro
        dependencies:
          - enrich-xgc-1-splits
          - fit-xgc-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgc_1_data
      - name: fit-kgml-xdtd-transformers
        template: kedro
        dependencies:
          - create-splits
        arguments:
          parameters:
          - name: kedro_node
            value: fit_kgml_xdtd_transformers
      - name: transform-xg-balanced-data
        template: kedro
        dependencies:
          - create-splits
          - fit-xg-balanced-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xg_balanced_data
      - name: create-tn-pairs
        template: kedro
        dependencies:
          - fabricate-datasets
        arguments:
          parameters:
          - name: kedro_node
            value: create_tn_pairs
      - name: fit-xgc-transformers
        template: kedro
        dependencies:
          - create-splits
        arguments:
          parameters:
          - name: kedro_node
            value: fit_xgc_transformers
      - name: write-rtx-kg2-edges
        template: kedro
        dependencies:
          - fabricate-datasets
        arguments:
          parameters:
          - name: kedro_node
            value: write_rtx_kg2_edges
      - name: transform-kgml-xdtd-data
        template: kedro
        dependencies:
          - create-splits
          - fit-kgml-xdtd-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_kgml_xdtd_data
      - name: enrich-xgc-2-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_xgc_2_splits
      - name: tune-model-xgc-2-parameters
        template: kedro
        dependencies:
          - transform-xgc-2-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_xgc_2_parameters
      - name: transform-xgc-2-data
        template: kedro
        dependencies:
          - enrich-xgc-2-splits
          - fit-xgc-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgc_2_data
      - name: create-neo4j-known-pairs
        template: kedro
        dependencies:
          - create-neo4j-nodes
          - create-int-known-pairs
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_known_pairs
      - name: transform-kgml-xdtd-0-data
        template: kedro
        dependencies:
          - fit-kgml-xdtd-transformers
          - enrich-kgml-xdtd-0-splits
        arguments:
          parameters:
          - name: kedro_node
            value: transform_kgml_xdtd_0_data
      - name: create-int-known-pairs
        template: kedro
        dependencies:
          - create-tn-pairs
          - create-tp-pairs
        arguments:
          parameters:
          - name: kedro_node
            value: create_int_known_pairs
      - name: transform-xgb-data
        template: kedro
        dependencies:
          - create-splits
          - fit-xgb-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgb_data
      - name: train-xgc-1-model
        template: kedro
        dependencies:
          - tune-model-xgc-1-parameters
          - transform-xgc-1-data
        arguments:
          parameters:
          - name: kedro_node
            value: train_xgc_1_model
      - name: fabricate-datasets
        template: kedro
        arguments:
          parameters:
          - name: kedro_node
            value: fabricate_datasets
      - name: get-xgb-model-predictions
        template: kedro
        dependencies:
          - create-xgb-model
          - transform-xgb-data
        arguments:
          parameters:
          - name: kedro_node
            value: get_xgb_model_predictions
      - name: train-kgml-xdtd-0-model
        template: kedro
        dependencies:
          - transform-kgml-xdtd-0-data
          - tune-model-kgml-xdtd-0-parameters
        arguments:
          parameters:
          - name: kedro_node
            value: train_kgml_xdtd_0_model
      - name: check-kgml-xdtd-model-performance
        template: kedro
        dependencies:
          - get-kgml-xdtd-model-predictions
        arguments:
          parameters:
          - name: kedro_node
            value: check_kgml_xdtd_model_performance
      - name: enrich-xgc-1-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_xgc_1_splits
      - name: tune-model-xgc-0-parameters
        template: kedro
        dependencies:
          - transform-xgc-0-data
        arguments:
          parameters:
          - name: kedro_node
            value: tune_model_xgc_0_parameters
      - name: enrich-xgc-0-splits
        template: kedro
        dependencies:
          - create-splits
          - create-feat-nodes
        arguments:
          parameters:
          - name: kedro_node
            value: enrich_xgc_0_splits
      - name: create-neo4j-edges
        template: kedro
        dependencies:
          - create-neo4j-nodes
          - write-rtx-kg2-edges
        arguments:
          parameters:
          - name: kedro_node
            value: create_neo4j_edges
      - name: transform-xgc-data
        template: kedro
        dependencies:
          - create-splits
          - fit-xgc-transformers
        arguments:
          parameters:
          - name: kedro_node
            value: transform_xgc_data
      - name: create-xgc-model
        template: kedro
        dependencies:
          - train-xgc-2-model
          - train-xgc-1-model
          - train-xgc-0-model
        arguments:
          parameters:
          - name: kedro_node
            value: create_xgc_model
