{# <project_root>/templates/argo_spec.tmpl #}
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: {{ package_name }}-
spec:
  entrypoint: dag
  templates:
  - name: kedro
    metadata:
      labels:
        {# Add label to have an ability to remove Kedro Pods easily #}
        app: kedro-argo
    inputs:
      parameters:
      - name: kedro_node
    container:
      imagePullPolicy: Always
      image: {{ image }}
      env:
        - name: NEO4J_HOST
          value: bolt://127.0.0.1:7687
        - name: NEO4J_USER
          value: neo4j
        - name: NEO4J_PASSWORD
          value: admin
        - name: OPENAI_ENDPOINT
          value: http://mock-genai:1080/v1
        - name: OPENAI_API_KEY
          value: dummy
        - name: GCP_PROJECT
          value: mtrx-hub-dev-3of
        - name: GCP_PROJECT_ID
          value: mtrx-hub-dev-3of
        - name: GCP_BUCKET
          value: gs://mtrx-us-central1-hub-dev-storage
        - name: VERTEX_AI_ACCESS_TOKEN
          value: dummy
      # env:
      #   - name: AWS_ACCESS_KEY_ID
      #     valueFrom:
      #       secretKeyRef:
      #         {# Secrets name #}
      #         name: aws-secrets
      #         key: access_key_id
      #   - name: AWS_SECRET_ACCESS_KEY
      #     valueFrom:
      #       secretKeyRef:
      #         name: aws-secrets
      #         key: secret_access_key
      command: [kedro]
      args: ["run", "-p", "{{ pipeline }}", "-e", "{{ env }}", "-n", {% raw %}"{{inputs.parameters.kedro_node}}" {% endraw %}]
  - name: dag
    dag:
      tasks:
      {% for task in tasks %}
      - name: {{ task.name }}
        template: kedro
        {% if task.deps %}
        dependencies:
        {% for dep in task.deps %}
          - {{ dep }}
        {% endfor %}
        {% endif %}
        arguments:
          parameters:
          - name: kedro_node
            value: {{ task.node }}
      {% endfor %}