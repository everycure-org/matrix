_bigquery_ds: &_bigquery_ds
  type: matrix.datasets.gcp.BigQueryTableDataset
  project_id: ${oc.env:GCP_PROJECT_ID}
  dataset: release_${globals:versions.release}
  file_format: parquet
  save_args:
    mode: overwrite
    labels:
      git_sha: ${globals:git_sha}

embeddings.feat.nodes:
  <<: *_bigquery_ds
  filepath: ${globals:paths.embeddings}/feat/nodes_with_embeddings
  table: topological_embeddings

embeddings.reporting.topological_pca:
  <<: *_bigquery_ds
  filepath: ${globals:paths.embeddings}/reporting/topological_pca
  table: pca_embeddings

embeddings.reporting.loss:
  type: kedro_mlflow.io.artifacts.MlflowArtifactDataset
  artifact_path: topological
  dataset:
    # NOTE: Data needs to be stored locally for MLFlow
    # to be able to upload to GCS. The ML Tracking server
    # is setup to not serve artifacts, thereby interacting
    # directly with GCS as a result.
    type: kedro_datasets.matplotlib.MatplotlibWriter
    filepath: ${globals:paths.tmp}/convergence_plot.png

embeddings.reporting.topological_pca_plot:
  type: kedro_mlflow.io.artifacts.MlflowArtifactDataset
  artifact_path: topological
  dataset:
    # NOTE: Data needs to be stored locally for MLFlow
    # to be able to upload to GCS. The ML Tracking server
    # is setup to not serve artifacts, thereby interacting
    # directly with GCS as a result.
    type: kedro_datasets.matplotlib.MatplotlibWriter
    filepath: ${globals:paths.tmp}/pca_plot.png