_layer_raw: &_layer_raw
  metadata:
    kedro-viz:
      layer: raw

_layer_int: &_layer_int
  metadata:
    kedro-viz:
      layer: integration

_layer_prm: &_layer_prm
  metadata:
    kedro-viz:
      layer: primary

_spark_parquet_ds: &_spark_parquet
  type: matrix_gcp_datasets.gcp.LazySparkDataset
  file_format: parquet
  save_args:
    mode: overwrite

_pandas_parquet_ds: &_pandas_parquet
  type: matrix.datasets.graph.PandasParquetDataset
  save_args:
    engine: pyarrow
  load_args:
    engine: pyarrow

_polars_csv_ds: &_polars_csv
  type: polars.CSVDataset
  save_args:
    separator: "\t"
    include_header: true
  load_args:
    infer_schema_length: 0
    has_header: true
    ignore_errors: true
    truncate_ragged_lines: true

# -------------------------------------------------------------------------
# Datasets
# -------------------------------------------------------------------------
preprocessing.raw.embiology.node_attributes:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/csv/attr.csv.gz

# NOTE: references.csv.gz is a very large dataframe which cant be easily loaded into memory
# so only load columns that are needed.
preprocessing.raw.embiology.ref_pub:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/csv/reference.csv.gz
  load_args:
    usecols:
      - "id"
      - "unique_ref"
      - "pmid"
      - "doi"

preprocessing.int.embiology.edge_attributes:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/int/edge_attributes

preprocessing.int.embiology.node_attributes@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/attr

preprocessing.int.embiology.node_attributes@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/attr

preprocessing.int.embiology.ref_pub@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/ref_pub

preprocessing.int.embiology.ref_pub@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/ref_pub

preprocessing.raw.embiology.nodes:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/csv/node.csv.gz

preprocessing.int.embiology.nodes@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/nodes

preprocessing.int.embiology.nodes@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/nodes

preprocessing.prm.embiology.nodes:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/nodes

preprocessing.raw.embiology.manual_id_mapping:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/temp/id_curie_mapping.csv

preprocessing.raw.embiology.manual_name_mapping:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/temp/name_curie_mapping.csv

preprocessing.int.embiology.manual_name_mapping@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/name_curie_mapping

preprocessing.int.embiology.manual_id_mapping@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/id_curie_mapping

preprocessing.int.embiology.manual_name_mapping@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/name_curie_mapping

preprocessing.int.embiology.manual_id_mapping@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/id_curie_mapping


preprocessing.prm.embiology.edges:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/edges

preprocessing.prm.embiology.nodes_final:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/nodes_final

preprocessing.prm.embiology.edges_final:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/prm/edges_final

preprocessing.raw.embiology.edges:
  type: pandas.CSVDataset
  filepath: ${globals:paths.raw_private}/source_data/raw_embiology/csv/control.csv.gz

preprocessing.int.embiology.edges@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/edges

preprocessing.int.embiology.edges@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/raw/edges

preprocessing.int.embiology.node_attributes_normalised_ids@pandas:
  <<: *_pandas_parquet
  filepath: ${globals:paths.tmp}/embiology/int/node_attributes_normalised_ids

preprocessing.int.embiology.node_attributes_normalised_ids@spark:
  <<: *_spark_parquet
  filepath: ${globals:paths.tmp}/embiology/int/node_attributes_normalised_ids

preprocessing.int.mapped_clinical_trials_data:
  type:  pandas.CSVDataset
  filepath: ${globals:paths.tmp}/preprocessing_clinical_trials.tsv
  load_args:
    sep: "\t"
  save_args:
    sep: "\t"

# PrimeKG
preprocessing.raw.primekg.drug_features@polars:
  <<: [*_polars_csv]
  filepath: ${globals:paths.raw}/KGs/prime-kg/${globals:preprocessing.primekg.version}/drug_features.csv

preprocessing.raw.primekg.disease_features@polars:
  <<: [*_polars_csv]
  filepath: ${globals:paths.raw}/KGs/prime-kg/${globals:preprocessing.primekg.version}/disease_features.csv

preprocessing.raw.primekg.nodes@polars:
  <<: [*_polars_csv]
  filepath: ${globals:paths.raw}/KGs/prime-kg/${globals:preprocessing.primekg.version}/nodes.csv

preprocessing.raw.primekg.kg@polars:
  <<: [*_polars_csv]
  filepath: ${globals:paths.raw}/KGs/prime-kg/${globals:preprocessing.primekg.version}/kg.csv

preprocessing.int.primekg.nodes:
  <<: [*_polars_csv]
  filepath: ${globals:paths.tmp}/preprocessing/int/prime-kg/${globals:preprocessing.primekg.version}.${globals:preprocessing.primekg.patch}/prime-kg-${globals:preprocessing.primekg.version}.${globals:preprocessing.primekg.patch}_nodes.tsv

preprocessing.int.primekg.edges:
  <<: [*_polars_csv]
  filepath: ${globals:paths.tmp}/preprocessing/int/prime-kg/${globals:preprocessing.primekg.version}.${globals:preprocessing.primekg.patch}/prime-kg-${globals:preprocessing.primekg.version}.${globals:preprocessing.primekg.patch}_edges.tsv
